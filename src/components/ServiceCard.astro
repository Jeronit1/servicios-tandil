---
import { urlFor } from '../lib/sanity';

const { 
  _id, // <--- IMPORTANTE: Recibimos el ID del oficio para el formulario
  titulo, rubro, descripcion, imagenes, whatsapp, barrio, 
  instagram, facebook, puntuacion, cantidad_votos, priority = false
} = Astro.props;

// --- CONFIGURACI√ìN DEL FORMULARIO DE RESE√ëAS ---
// 1. Pega aqu√≠ el link de tu formulario (borra todo lo que sigue al 'viewform')
const FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLServtMX2MC-S_7XyJ-OnfNr6aPHOZExyQg9nw9M0gDdONi0kw/viewform";

// 2. Pega aqu√≠ los IDs de los campos que encontraste
const ENTRY_NOMBRE = "entry.1936463075"; // ID del campo "Nombre del Prestador"
const ENTRY_REF_ID = "entry.873200862"; // ID del campo "Reference ID"

// Generamos el link m√°gico:
// Une la base + el nombre del servicio + el ID secreto del servicio
const linkCalificar = `${FORM_BASE_URL}?usp=pp_url&${ENTRY_NOMBRE}=${encodeURIComponent(titulo)}&${ENTRY_REF_ID}=${_id}`;


// --- L√ìGICA VISUAL (Carrusel, Estrellas, etc) ---
const uniqueId = Math.random().toString(36).substr(2, 9);
const cardId = `card-${uniqueId}`;

const hasImages = imagenes && imagenes.length > 0;
const slides = hasImages ? imagenes : ["placeholder"];

const getImageUrl = (img) => {
  if (img === "placeholder") return "https://via.placeholder.com/600x450?text=Sin+Foto";
  return urlFor(img)
    .width(600)
    .height(450)
    .fit('crop')
    .auto('format') // Convierte a WebP autom√°ticamente
    .quality(80)    // Baja el peso sin perder nitidez visible
    .url();
};

const mensaje = `Hola, te contacto por Servicios Tandil. Vi tu perfil de ${rubro} y me interesa un presupuesto.`;
const linkWhatsapp = `https://wa.me/${whatsapp}?text=${encodeURIComponent(mensaje)}`;
const linkInstagram = instagram ? `https://www.instagram.com/${instagram}` : null;
const linkFacebook = facebook ? `https://www.facebook.com/${facebook}` : null;

// L√≥gica de estrellas
const rating = puntuacion || 0; 
const votos = cantidad_votos || 0;
const stars = [1, 2, 3, 4, 5];
const getFillPercent = (starIndex) => {
  const fill = (rating - (starIndex - 1)) * 100;
  return Math.min(Math.max(fill, 0), 100);
};
---

<article 
  class="card service-item" 
  data-rubro={rubro} 
  data-texto={`${titulo} ${descripcion} ${barrio || ''}`.toLowerCase()}
>
  
  <div class="carousel-wrapper" id={cardId}>
    <div class="carousel-slides">
      {slides.map((img) => (
        <div class="slide-container">
          {/* üëá MODIFICA ESTA L√çNEA AS√ç: */}
          <img 
            src={getImageUrl(img)} 
            alt={titulo} 
            class="zoomable" 
            loading={priority ? "eager" : "lazy"}
            fetchpriority={priority ? "high" : "auto"} 
          />
        </div>
      ))}
    </div>
    {hasImages && slides.length > 1 && (
      <>
        <button class="nav-btn prev">‚ùÆ</button>
        <button class="nav-btn next">‚ùØ</button>
        <div class="badge-count">1 / {slides.length}</div>
      </>
    )}
    {barrio && <span class="badge-barrio">{barrio}</span>}
  </div>
  
  <div class="contenido">
    <div class="header-card">
      <span class="rubro">{rubro.toUpperCase()}</span>
      
      <div class="rating-container" title={`Valoraci√≥n: ${rating} de 5`}>
        <div class="stars">
          {stars.map((star) => {
            const percent = getFillPercent(star);
            const gradientId = `grad-${uniqueId}-${star}`;
            return (
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke="none">
                <defs>
                  <linearGradient id={gradientId}>
                    <stop offset={`${percent}%`} stop-color="#FFD700" />
                    <stop offset={`${percent}%`} stop-color="#e0e0e0" />
                  </linearGradient>
                </defs>
                <polygon fill={`url(#${gradientId})`} points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
            )
          })}
        </div>
        {votos > 0 && <span class="votos-text">({votos})</span>}
      </div>
    </div>

    <h3>{titulo}</h3>
    <p class="descripcion">{descripcion}</p>
    
    <div class="acciones">
      
      <a href={linkWhatsapp} target="_blank" class="btn btn-whatsapp">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
        Contactar
      </a>

      {(linkInstagram || linkFacebook) && (
        <div class="fila-social">
          {linkInstagram && (
            <a href={linkInstagram} target="_blank" class="btn btn-social btn-insta" title="Instagram">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
              Instagram
            </a>
          )}
          {linkFacebook && (
            <a href={linkFacebook} target="_blank" class="btn btn-social btn-face" title="Facebook">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
              Facebook
            </a>
          )}
        </div>
      )}

      <a href={linkCalificar} target="_blank" class="btn btn-rate">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        Calificar 
      </a>

    </div>
  </div>
</article>

<style>
  /* --- ESTRUCTURA --- */
  .card {
    background: white; border-radius: 16px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    overflow: hidden; display: flex; flex-direction: column;
    border: 1px solid #eee; transition: transform 0.2s;
  }
  .card:hover { transform: translateY(-5px); }

  /* --- CARRUSEL --- */
  .carousel-wrapper { position: relative; height: 240px; background: #f0f0f0; overflow: hidden; }
  .carousel-slides {
    display: flex; flex-direction: row; flex-wrap: nowrap; overflow-x: auto;
    scroll-snap-type: x mandatory; height: 100%; width: 100%;
    scrollbar-width: none; 
  }
  .carousel-slides::-webkit-scrollbar { display: none; }
  .slide-container { min-width: 100%; flex: 0 0 100%; height: 100%; scroll-snap-align: center; }
  .slide-container img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .zoomable {
    cursor: zoom-in; /* Muestra la lupa */
    transition: transform 0.3s ease;
  }
  
  /* Opcional: Un peque√±o efecto al pasar el mouse */
  .zoomable:hover {
    transform: scale(1.02);
  }

  .nav-btn {
    position: absolute; top: 50%; transform: translateY(-50%);
    background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px;
    border-radius: 50%; cursor: pointer; z-index: 10; display: flex; 
    align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
  }
  .carousel-wrapper:hover .nav-btn { opacity: 1; }
  .prev { left: 10px; } .next { right: 10px; }
  .badge-barrio { position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.95); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; z-index: 5; }
  .badge-count { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; pointer-events: none; z-index: 5; }

  /* --- CONTENIDO --- */
  .contenido { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
  
  .header-card { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
  .rubro { color: #666; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }
  
  .rating-container { display: flex; align-items: center; gap: 4px; }
  .stars { display: flex; gap: 1px; }
  .votos-text { font-size: 0.75rem; color: #888; font-weight: 500; margin-left: 4px; }

  h3 { margin: 0 0 0.5rem 0; font-size: 1.4rem; color: #1a1a1a; font-weight: 800; line-height: 1.2; }
  .descripcion { color: #555; font-size: 0.95rem; line-height: 1.5; margin-bottom: 1.5rem; flex-grow: 1; }

  /* --- BOTONES --- */
  .acciones { display: flex; flex-direction: column; gap: 8px; }
  
  .btn { display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; padding: 12px; border-radius: 10px; font-weight: 600; font-size: 0.95rem; transition: transform 0.1s; }
  .btn:active { transform: scale(0.98); }

  .btn-whatsapp { background-color: #25D366; color: white; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.2); }
  .btn-whatsapp:hover { background-color: #20bd5a; }

  .fila-social { display: flex; gap: 8px; }
  .btn-social { flex: 1; font-size: 0.9rem; padding: 10px; border: 1px solid transparent; }
  
  .btn-insta { background: #fff0f5; color: #C13584; border-color: #fad0d0; }
  .btn-insta:hover { background: #ffe4ef; }

  .btn-face { background: #eaf3ff; color: #1877F2; border-color: #d0e4ff; }
  .btn-face:hover { background: #dcebff; }

  /* ESTILO NUEVO DEL BOT√ìN CALIFICAR */
  .btn-rate {
    background-color: transparent;
    color: #888;
    border: 1px solid #e0e0e0;
    font-size: 0.85rem;
    padding: 8px;
    margin-top: 5px; /* Separaci√≥n visual */
  }
  .btn-rate:hover {
    border-color: #aaa;
    color: #333;
    background-color: #fcfcfc;
  }

</style>

<script>
  document.querySelectorAll('.carousel-wrapper').forEach(wrapper => {
    const container = wrapper.querySelector('.carousel-slides');
    const nextBtn = wrapper.querySelector('.next');
    const prevBtn = wrapper.querySelector('.prev');
    const counter = wrapper.querySelector('.badge-count');
    if (!container || !nextBtn) return;

    const updateCounter = () => {
      if(!counter) return;
      const width = container.clientWidth;
      const index = Math.round(container.scrollLeft / width) + 1;
      const total = container.children.length;
      counter.textContent = `${index} / ${total}`;
    };
    container.addEventListener('scroll', updateCounter);
    nextBtn.addEventListener('click', () => container.scrollBy({ left: container.clientWidth, behavior: 'smooth' }));
    prevBtn.addEventListener('click', () => container.scrollBy({ left: -container.clientWidth, behavior: 'smooth' }));
  });
</script>