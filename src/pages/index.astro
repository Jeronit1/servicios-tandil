---
import { client } from '../lib/sanity';
import ServiceCard from '../components/ServiceCard.astro';
import HeroSearch from '../components/HeroSearch.astro'; // <--- 1. Importamos el Buscador
import SpeedInsights from '@vercel/speed-insights/astro';

// CONSULTA A LA BASE DE DATOS (GROQ)
// Traemos todos los datos necesarios, incluyendo las redes y puntuaci칩n
// CONSULTA INTELIGENTE (GROQ)
const query = `*[_type == "oficio"] | order(_createdAt desc) {
  _id,
  titulo,
  rubro,
  descripcion,
  imagenes,
  whatsapp,
  barrio,
  instagram,
  facebook,
  
  // DATOS MANUALES (Los que cargas t칰 en Sanity)
  "puntuacion_manual": puntuacion,
  "votos_manuales": cantidad_votos,

  // DATOS AUTOM츼TICOS (Calculados de las rese침as reales)
  "promedio_real": math::avg(*[_type == "resena" && oficio._ref == ^._id].puntuacion),
  "conteo_real": count(*[_type == "resena" && oficio._ref == ^._id])
}`;

const oficios = await client.fetch(query);
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Servicios Tandil</title>
    <link rel="icon" type="image/svg+xml" href="/favicon1.svg" />
    <meta name="description" content="Encuentra los mejores servicios en Tandil. Gu칤a de oficios con rese침as reales de vecinos. Plomeros, electricistas, pintores y m치s.">

    <meta property="og:type" content="website" />
    <meta property="og:title" content="Servicios Tandil - Gu칤a de Oficios" />
    <meta property="og:description" content="쮹uscas plomero, gasista o electricista en Tandil? Mira las rese침as de tus vecinos aqu칤." />
    <meta property="og:image" content="https://servicios-tandil.vercel.app/social-image.jpg" /> <meta property="og:url" content="https://servicios-tandil.vercel.app/" />
 </head>
  <body>
    <HeroSearch />

    <main class="container">
      
      <div class="grid">
        {oficios.map((oficio) => {
          
          // L칍GICA DE PRIORIDAD:
          // 1. 쯊iene rese침as reales? Usamos el promedio real.
          // 2. 쯅o tiene? Usamos el manual que pusiste en Sanity.
          // 3. 쯊ampoco tiene manual? Ponemos 0.
          const ratingFinal = oficio.promedio_real || oficio.puntuacion_manual || 0;
          
          // Lo mismo para los votos: Si hay reales mostramos esos, si no los manuales (ej: "12 votos")
          const votosFinales = oficio.conteo_real > 0 ? oficio.conteo_real : (oficio.votos_manuales || 0);

          return (
            <ServiceCard 
              _id={oficio._id}
              titulo={oficio.titulo}
              rubro={oficio.rubro}
              descripcion={oficio.descripcion}
              imagenes={oficio.imagenes}
              whatsapp={oficio.whatsapp}
              barrio={oficio.barrio}
              instagram={oficio.instagram}
              facebook={oficio.facebook}
              
              /* AQU칈 PASAMOS LOS VALORES CALCULADOS */
              puntuacion={ratingFinal}
              cantidad_votos={votosFinales}
            />
          )
        })}
      </div>

      <div id="no-results" class="no-results-message" style="display: none;">
        <div class="icon-sad">游땟</div>
        <h3>No encontramos servicios con esa b칰squeda</h3>
        <p>Intenta con otra palabra clave o selecciona "Todos los Rubros".</p>
      </div>

    </main>

    <div id="image-modal" class="modal-overlay">
      <span class="close-btn">&times;</span>
      
      <a class="modal-prev">&#10094;</a>
      
      <img class="modal-content" id="img-enlarged" />
      
      <a class="modal-next">&#10095;</a>
      
      <div id="caption"></div>
    </div>

    <script>
      // VARIABLES GLOBALES PARA LA GALER칈A
      let currentGallery = []; // Aqu칤 guardaremos las fotos de la tarjeta actual
      let currentIndex = 0;    // El 칤ndice de la foto que estamos viendo

      const modal = document.getElementById('image-modal');
      const modalImg = document.getElementById('img-enlarged') as HTMLImageElement;
      const captionText = document.getElementById('caption');
      const closeBtn = document.querySelector('.close-btn');
      const nextBtn = document.querySelector('.modal-next');
      const prevBtn = document.querySelector('.modal-prev');

      // 1. ABRIR EL MODAL Y DETECTAR GALER칈A
      document.querySelectorAll('.zoomable').forEach((img) => {
        img.addEventListener('click', (e) => {
          const target = e.target as HTMLImageElement;
          
          // Truco: Buscamos el contenedor padre para saber qu칠 fotos pertenecen a ESTE servicio
          const container = target.closest('.carousel-slides');
          
          if (container) {
            // Guardamos todas las im치genes de ESTA tarjeta espec칤fica
            currentGallery = Array.from(container.querySelectorAll('.zoomable')) as HTMLImageElement[];
            // Encontramos en qu칠 posici칩n est치 la foto que clickeamos
            currentIndex = currentGallery.indexOf(target);
          } else {
            // Si por algo falla, hacemos una galer칤a de 1 sola foto
            currentGallery = [target];
            currentIndex = 0;
          }

          openModal();
        });
      });

      function openModal() {
        if (!modal || !modalImg) return;
        modal.style.display = "flex";
        updateImage();
      }

      function updateImage() {
        if (!modalImg || !captionText) return;
        const imgObj = currentGallery[currentIndex];
        
        modalImg.src = imgObj.src;
        captionText.innerText = imgObj.alt;

        // Ocultar flechas si solo hay 1 foto
        if (currentGallery.length <= 1) {
            if(nextBtn) (nextBtn as HTMLElement).style.display = 'none';
            if(prevBtn) (prevBtn as HTMLElement).style.display = 'none';
        } else {
            if(nextBtn) (nextBtn as HTMLElement).style.display = 'block';
            if(prevBtn) (prevBtn as HTMLElement).style.display = 'block';
        }
      }

      // 2. NAVEGACI칍N (Siguiente / Anterior)
      function showNext() {
        currentIndex++;
        if (currentIndex >= currentGallery.length) {
          currentIndex = 0; // Vuelve al principio (loop)
        }
        updateImage();
      }

      function showPrev() {
        currentIndex--;
        if (currentIndex < 0) {
          currentIndex = currentGallery.length - 1; // Va al final (loop)
        }
        updateImage();
      }

      if (nextBtn) nextBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Evita que se cierre el modal al hacer clic
        showNext();
      });

      if (prevBtn) prevBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        showPrev();
      });

      // Teclas del teclado (Flechas izquierda/derecha)
      document.addEventListener('keydown', (e) => {
        if (modal && modal.style.display === "flex") {
          if (e.key === "ArrowRight") showNext();
          if (e.key === "ArrowLeft") showPrev();
          if (e.key === "Escape") closeModal();
        }
      });

      // 3. CERRAR MODAL
      function closeModal() {
        if (modal) modal.style.display = "none";
      }

      if (closeBtn) closeBtn.addEventListener('click', closeModal);
      
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
      }
    </script>

    <SpeedInsights />
  </body>
</html>

<style>
  /* ESTILOS GLOBALES */
  body { 
    font-family: 'Segoe UI', system-ui, sans-serif; 
    margin: 0; 
    background-color: #f4f6f8; 
    padding-bottom: 50px;
  }
  
  .container { 
    max-width: 1100px; 
    margin: 0 auto; 
    padding: 2rem 1rem; 
  }

  /* GRILLA RESPONSIVA */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Tarjetas un poco m치s anchas */
    gap: 2rem;
  }

  /* ESTILO DEL MENSAJE SIN RESULTADOS */
  .no-results-message {
    text-align: center;
    padding: 3rem;
    color: #666;
    animation: fadeIn 0.5s ease;
  }
  .icon-sad { font-size: 3rem; margin-bottom: 1rem; }
  .no-results-message h3 { margin: 0; color: #333; }

  /* BOTONES DE NAVEGACI칍N (FLECHAS) */
  .modal-prev, .modal-next {
    cursor: pointer;
    position: absolute;
    top: 50%;
    width: auto;
    padding: 16px;
    margin-top: -50px;
    color: white;
    font-weight: bold;
    font-size: 40px; /* Flechas grandes */
    transition: 0.3s ease;
    border-radius: 0 3px 3px 0;
    user-select: none;
    z-index: 1001;
  }

  /* Posici칩n Izquierda */
  .modal-prev {
    left: 20px; /* Un poco separado del borde */
    border-radius: 3px 0 0 3px;
  }

  /* Posici칩n Derecha */
  .modal-next {
    right: 20px;
    border-radius: 3px 0 0 3px;
  }

  /* Efecto Hover */
  .modal-prev:hover, .modal-next:hover {
    background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro al pasar el mouse */
    transform: scale(1.1); /* Crece un poquito */
  }

  /* Asegurar que la imagen no tape las flechas en m칩viles */
  @media (max-width: 768px) {
    .modal-prev, .modal-next {
      font-size: 30px;
      padding: 10px;
    }
  }

  /* ESTILOS DEL MODAL (Fondo Oscuro) */
  .modal-overlay {
    display: none; /* Oculto por defecto */
    position: fixed;
    z-index: 1000; /* Por encima de todo */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.9); /* Fondo negro semitransparente */
    justify-content: center;
    align-items: center;
    flex-direction: column;
    animation: fadeIn 0.3s;
  }

  /* La imagen agrandada */
  .modal-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 80vh;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(255,255,255,0.2);
    animation: zoomIn 0.3s;
  }

  /* Texto de descripci칩n */
  #caption {
    margin: 15px 0;
    width: 80%;
    text-align: center;
    color: #ccc;
    font-size: 1.2rem;
  }

  /* Bot칩n de cerrar (X) */
  .close-btn {
    position: absolute;
    top: 20px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
  }
  .close-btn:hover {
    color: #bbb;
  }

  /* Animaciones suaves */
  @keyframes zoomIn {
    from {transform:scale(0)} 
    to {transform:scale(1)}
  }
  @keyframes fadeIn {
    from {opacity:0} 
    to {opacity:1}
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>